const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

// Configuration
const API_CONFIG_PATH = path.join(__dirname, '..', 'lib', 'api-config.ts');
const BACKEND_PORT = 5000;
const EXPO_PORT = 8081;

function log(prefix, data) {
    const lines = data.toString().split('\n');
    lines.forEach(line => {
        if (line.trim()) console.log(`[${prefix}] ${line.trim()}`);
    });
}

// Helper to start a tunnel and return its URL
function startTunnel(port, label) {
    return new Promise((resolve, reject) => {
        console.log(`ðŸš‡ Starting LocalTunnel for ${label} (Port ${port})...`);
        const lt = spawn('npx', ['lt', '--port', port], {
            cwd: path.join(__dirname, '..'),
            shell: true
        });

        let resolved = false;

        lt.stdout.on('data', (data) => {
            const output = data.toString();
            // log(`TUNNEL_${label}`, output);

            const match = output.match(/your url is: (https:\/\/[a-zA-Z0-9-]+\.loca\.lt)/);
            if (match && !resolved) {
                resolved = true;
                const url = match[1];
                console.log(`âœ… ${label} Tunnel established at: ${url}`);
                resolve(url);
            }
        });

        lt.stderr.on('data', data => {
            // log(`TUNNEL_${label}_ERR`, data);
        });

        // Timeout fallback
        setTimeout(() => {
            if (!resolved) {
                console.warn(`âš ï¸  Timeout waiting for ${label} tunnel. Check internet connection.`);
                // resolve(null); // Don't resolve null, keeps waiting or user kills it
            }
        }, 10000);
    });
}

async function start() {
    console.log('ðŸš€ Starting Campus Confessions Dual-Tunnel Dev Environment...');

    // 1. Start Backend Server
    console.log('ðŸ“¦ Starting Backend Server...');
    const server = spawn('tsx', ['server/index.ts'], {
        cwd: path.join(__dirname, '..'),
        shell: true,
        env: { ...process.env, PORT: BACKEND_PORT.toString() }
    });

    server.stdout.on('data', data => log('SERVER', data));
    server.stderr.on('data', data => log('SERVER', data));

    // 2. Start Tunnels in Parallel
    const [backendUrl, expoUrl] = await Promise.all([
        startTunnel(BACKEND_PORT, "BACKEND"),
        startTunnel(EXPO_PORT, "EXPO")
    ]);

    if (!backendUrl || !expoUrl) {
        console.error("âŒ Failed to establish tunnels. Exiting.");
        process.exit(1);
    }

    // 3. Update API Config with Backend URL
    updateApiConfig(backendUrl);

    // 4. Start Expo with Custom Hostname
    startExpo(expoUrl);
}

function updateApiConfig(url) {
    console.log('ðŸ“ Updating API Config...');
    let content = fs.readFileSync(API_CONFIG_PATH, 'utf8');

    const replacement = `    const TUNNEL_URL = "${url}"; // Auto-generated by start-with-tunnel.js`;
    const regex = /const TUNNEL_URL = ".*";.*$/m;

    if (regex.test(content)) {
        content = content.replace(regex, replacement);
        fs.writeFileSync(API_CONFIG_PATH, content);
        console.log('âœ… API Config updated!');
    } else {
        console.error('âŒ Could not find TUNNEL_URL placeholder in api-config.ts');
    }
}

function startExpo(expoTunnelUrl) {
    console.log(`ðŸ“± Starting Expo bound to ${expoTunnelUrl}...`);

    // Extract hostname (remove https://)
    const hostname = expoTunnelUrl.replace('https://', '').replace('http://', '');

    // We use a slight delay to ensure file write is detected
    setTimeout(() => {
        const expo = spawn('npx', ['expo', 'start', '--clear', '--localhost'], {
            cwd: path.join(__dirname, '..'),
            shell: true,
            stdio: 'inherit',
            env: {
                ...process.env,
                REACT_NATIVE_PACKAGER_HOSTNAME: hostname,
                EXPO_DEV_TOOLS_PORT: "19002"
            }
        });

        expo.on('close', (code) => {
            console.log(`Expo process exited with code ${code}`);
            process.exit(code);
        });
    }, 2000);
}

process.on('SIGINT', () => {
    console.log('\nðŸ›‘ Shutting down...');
    process.exit();
});

start();
